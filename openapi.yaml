openapi: 3.1.0
info:
  title: RAI (Recruitment AI Intelligence) API
  description: |
    RAI 이력서 분석 및 후보자 관리 API

    ## 인증
    모든 API는 Supabase Auth를 통한 인증이 필요합니다.
    Cookie 기반 세션 인증을 사용합니다.

    ## 크레딧 시스템
    - Starter: 월 50 크레딧
    - Pro: 월 150 크레딧
    - Enterprise: 월 300 크레딧

    이력서 분석 시 1 크레딧이 차감됩니다.
  version: 1.0.0
  contact:
    name: RAI Support
  license:
    name: Proprietary

servers:
  - url: https://your-domain.vercel.app/api
    description: Production
  - url: http://localhost:3000/api
    description: Development

tags:
  - name: Upload
    description: 이력서 업로드 및 처리
  - name: Candidates
    description: 후보자 관리
  - name: Search
    description: 후보자 검색
  - name: User
    description: 사용자 정보
  - name: Auth
    description: 인증

paths:
  /upload:
    post:
      tags: [Upload]
      summary: 이력서 업로드
      description: |
        이력서 파일을 업로드하고 AI 분석을 시작합니다.
        지원 형식: HWP, HWPX, DOC, DOCX, PDF
        최대 크기: 50MB
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: 이력서 파일
      responses:
        '200':
          description: 업로드 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '402':
          $ref: '#/components/responses/InsufficientCredits'
        '422':
          $ref: '#/components/responses/FileValidationError'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
    get:
      tags: [Upload]
      summary: 업로드 작업 상태 조회
      parameters:
        - name: jobId
          in: query
          schema:
            type: string
            format: uuid
          description: 작업 ID (생략 시 최근 20개 목록)
      responses:
        '200':
          description: 작업 정보
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ProcessingJob'
                  - type: array
                    items:
                      $ref: '#/components/schemas/ProcessingJob'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /candidates:
    get:
      tags: [Candidates]
      summary: 후보자 목록 조회
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: 페이지 번호
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: 페이지당 항목 수
        - name: sort
          in: query
          schema:
            type: string
            enum: [created_at, name, exp_years, confidence_score]
            default: created_at
          description: 정렬 기준
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: 정렬 순서
      responses:
        '200':
          description: 후보자 목록
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CandidateListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /candidates/{id}:
    get:
      tags: [Candidates]
      summary: 후보자 상세 조회
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 후보자 상세 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CandidateDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags: [Candidates]
      summary: 후보자 정보 수정
      description: AI 분석 결과를 사용자가 검토 후 수정합니다.
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CandidateUpdateRequest'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CandidateDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /candidates/{id}/export:
    post:
      tags: [Candidates]
      summary: 블라인드 이력서 내보내기
      description: |
        개인정보를 마스킹한 블라인드 이력서를 생성합니다.
        Starter 플랜: 월 30회 제한
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [pdf, docx]
                  default: pdf
                includePhoto:
                  type: boolean
                  default: false
                includePortfolio:
                  type: boolean
                  default: false
      responses:
        '200':
          description: 내보내기 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
    get:
      tags: [Candidates]
      summary: 내보내기 사용량 조회
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 사용량 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportUsage'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /search:
    post:
      tags: [Search]
      summary: 시맨틱 검색
      description: |
        자연어 쿼리로 후보자를 검색합니다.
        벡터 임베딩 기반 시맨틱 검색을 수행합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: 검색 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /search/feedback:
    post:
      tags: [Search]
      summary: 검색 피드백 저장
      description: 검색 결과에 대한 사용자 피드백을 저장합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchFeedbackRequest'
      responses:
        '200':
          description: 피드백 저장 성공
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/credits:
    get:
      tags: [User]
      summary: 크레딧 정보 조회
      description: 현재 사용자의 크레딧 잔액과 사용량을 조회합니다.
      responses:
        '200':
          description: 크레딧 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/check-email:
    post:
      tags: [Auth]
      summary: 이메일 중복 확인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: 이메일 확인 결과
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      available:
                        type: boolean

components:
  schemas:
    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            jobId:
              type: string
              format: uuid
            candidateId:
              type: string
              format: uuid
            message:
              type: string

    ProcessingJob:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        file_name:
          type: string
        file_size:
          type: integer
        file_type:
          type: string
        candidate_id:
          type: string
          format: uuid
        confidence_score:
          type: number
          format: float
        chunk_count:
          type: integer
        error_message:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CandidateListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            candidates:
              type: array
              items:
                $ref: '#/components/schemas/CandidateSummary'
            total:
              type: integer
            page:
              type: integer
            limit:
              type: integer

    CandidateSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        role:
          type: string
        company:
          type: string
        expYears:
          type: number
        skills:
          type: array
          items:
            type: string
        photoUrl:
          type: string
        summary:
          type: string
        aiConfidence:
          type: integer
          description: 0-100
        confidenceLevel:
          type: string
          enum: [high, medium, low]
        createdAt:
          type: string
          format: date-time

    CandidateDetail:
      allOf:
        - $ref: '#/components/schemas/CandidateSummary'
        - type: object
          properties:
            birthYear:
              type: integer
            gender:
              type: string
              enum: [male, female, other]
            phone:
              type: string
            email:
              type: string
              format: email
            address:
              type: string
            educationLevel:
              type: string
            educationSchool:
              type: string
            educationMajor:
              type: string
            locationCity:
              type: string
            careers:
              type: array
              items:
                $ref: '#/components/schemas/Career'
            projects:
              type: array
              items:
                $ref: '#/components/schemas/Project'
            education:
              type: array
              items:
                $ref: '#/components/schemas/Education'
            strengths:
              type: array
              items:
                type: string
            portfolioUrl:
              type: string
            githubUrl:
              type: string
            linkedinUrl:
              type: string
            analysisMode:
              type: string
              enum: [phase_1, phase_2]

    Career:
      type: object
      properties:
        company:
          type: string
        position:
          type: string
        department:
          type: string
        start_date:
          type: string
        end_date:
          type: string
        is_current:
          type: boolean
        description:
          type: string

    Project:
      type: object
      properties:
        name:
          type: string
        role:
          type: string
        period:
          type: string
        description:
          type: string
        technologies:
          type: array
          items:
            type: string

    Education:
      type: object
      properties:
        school:
          type: string
        degree:
          type: string
        major:
          type: string
        graduation_year:
          type: integer
        is_graduated:
          type: boolean

    CandidateUpdateRequest:
      type: object
      properties:
        name:
          type: string
        birthYear:
          type: integer
        gender:
          type: string
        phone:
          type: string
        email:
          type: string
        skills:
          type: array
          items:
            type: string
        summary:
          type: string

    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: 자연어 검색 쿼리
        limit:
          type: integer
          default: 10
          maximum: 50
        threshold:
          type: number
          format: float
          default: 0.7
          description: 유사도 임계값 (0-1)

    SearchResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            results:
              type: array
              items:
                type: object
                properties:
                  candidate:
                    $ref: '#/components/schemas/CandidateSummary'
                  similarity:
                    type: number
                  matchedChunks:
                    type: array
                    items:
                      type: string
            query:
              type: string
            searchId:
              type: string
              format: uuid

    SearchFeedbackRequest:
      type: object
      required:
        - searchId
        - candidateId
        - feedback
      properties:
        searchId:
          type: string
          format: uuid
        candidateId:
          type: string
          format: uuid
        feedback:
          type: string
          enum: [relevant, not_relevant, viewed]

    ExportResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            blindData:
              type: object
            maskedFields:
              type: array
              items:
                type: string
            fileName:
              type: string

    ExportUsage:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            plan:
              type: string
            monthlyLimit:
              type: integer
            used:
              type: integer
            remaining:
              type: integer

    CreditsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            credits:
              type: integer
              description: 추가 구매 크레딧
            creditsUsedThisMonth:
              type: integer
            plan:
              type: string
              enum: [starter, pro, enterprise]
            planBaseCredits:
              type: integer
            remainingCredits:
              type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

  responses:
    Unauthorized:
      description: 인증 필요
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: UNAUTHORIZED
              message: 로그인이 필요합니다.

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InsufficientCredits:
      description: 크레딧 부족
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: INSUFFICIENT_CREDITS
              message: 크레딧이 부족합니다.

    FileValidationError:
      description: 파일 검증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    RateLimitExceeded:
      description: 요청 한도 초과
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
