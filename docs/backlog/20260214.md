# SRCHD 멀티에이전트 시스템 개선 백로그 (2026-02-14)

> 코드리뷰 분석 결과를 기반으로 한 우선순위별 작업 목록
> 검토 기준일: 2026-02-14

**관련 문서**:
- PRD Section 21: [`docs/prd/srchd_prd_v0.1_20260213.md#21-code-review-action-plan`](../prd/srchd_prd_v0.1_20260213.md)
- 아키텍처 문서: [`docs/architecture/MULTI_AGENT_PIPELINE.md`](../architecture/MULTI_AGENT_PIPELINE.md)

---

## 현황 요약

| 항목 | 상태 |
|------|------|
| V2 기능 (Collaborative Orchestrator) | ~95% 구현 |
| V3 기능 (Advanced Optimizations) | ~40-50% 구현 |
| 멀티에이전트 구조 | 협업형보다 단계형 파이프라인에 가까움 |
| 서비스 오픈 가능 여부 | ✅ 가능 (단, 아래 P0 항목 선행 필요) |

### 코드리뷰 총평

> **멀티에이전트 구조는 "기반은 잘 깔렸고, 실제 운영 경로는 부분적으로만 활성화" 상태**
> - 컨텍스트 전달은 핵심 흐름에서 비교적 견고하나, "협업형 다중 에이전트"보다는 **오케스트레이터 중심의 단계형 파이프라인**
> - 프롬프팅 품질은 스키마/가이드가 있는 편이지만, 문서에서 주장하는 CoT/Few-shot/strict schema 수준과 실제 코드 구현 간 **격차** 존재
> - 서비스 오픈은 가능하나, 운영 리스크(기능 플래그 불일치, 메트릭 추정치, 메시지버스 실사용 부족, 문서-코드 괴리) 정리 선행 필요

---

## P0 - 출시 전 필수 (Week 1)

### 1. LLM 재시도 로직 실제 적용

**문제**: `config.py`에 `RetrySettings` 정의되어 있으나 `llm_manager.py`에서 미사용
**리스크**: Timeout 실패 시 즉시 에러 반환, 크레딧 손실

**현재 상태**:
```python
# config.py (정의됨)
class RetrySettings(BaseModel):
    llm_max: int = Field(default=2, description="LLM API 최대 재시도")

# llm_manager.py (미적용)
try:
    response = await asyncio.wait_for(...)
except asyncio.TimeoutError:
    return LLMResponse(..., error="...timeout...")  # 즉시 실패, 재시도 없음
```

**작업 내용**:
- [ ] `llm_manager.py`에 exponential backoff 재시도 로직 구현
- [ ] `settings.retry.llm_max` 값 활용
- [ ] Timeout/Rate Limit 에러 구분하여 재시도 정책 적용
- [ ] 실패 시 크레딧 환불 추적을 위한 응답 보존

**파일**: `apps/worker/services/llm_manager.py`

---

### 2. 메트릭 정확도 개선 (estimated vs actual)

**문제**: 토큰 사용량이 추정치로 기록되어 모델/프롬프트 변경 영향 판단 오류 가능
**리스크**: 품질 측정 부정확으로 의사결정 오류

**현재 상태**:
```python
# 토큰 추정치 사용
estimated_tokens = len(text) // 4
```

**작업 내용**:
- [ ] LLM 응답의 `response.usage.total_tokens` 실측값 수집
- [ ] 메트릭 필드에 `estimated` vs `actual` 구분 추가
- [ ] Provider별 실제 비용 계산 로직 추가
- [ ] 프롬프트/스키마 버전 키를 DB 혹은 로그에 남겨 회귀 분석 가능화

**파일**:
- `apps/worker/services/llm_manager.py`
- `apps/worker/services/metrics_service.py`

---

### 3. 문서-코드 정합성 회복

**문제**: `MULTI_AGENT_IMPLEMENTATION_PLAN.md`의 목표 기능 중 실제 구현되지 않은 항목 다수
**리스크**: 내부/외부 이해관계자 기대와 실제 동작 차이로 운영 혼선

**작업 내용**:
- [ ] 구현 계획서에 실구현/미구현 명시적 태깅
- [ ] "현재 실제 동작 아키텍처" 다이어그램 코드 기준으로 재작성
- [ ] Feature Flag별 실제 실행 경로/테스트 커버리지 표 작성

**미구현 항목 목록**:
| 기능 | 계획 위치 | 상태 |
|------|----------|------|
| CoT 프롬프팅 | `prompts/cot_prompts.py` | ❌ 미구현 |
| Few-shot 예시 | `prompts/few_shot_examples.py` | ❌ 미구현 |
| Context 압축 | `services/context_compressor.py` | ❌ 미구현 |
| Batch Processor | `orchestrator/batch_processor.py` | ❌ 미구현 |
| Model Selector | `orchestrator/model_selector.py` | ❌ 미구현 |
| Result Cache | `agents/cache/sub_agent_cache.py` | ❌ 미구현 |

**파일**: `docs/specs/MULTI_AGENT_IMPLEMENTATION_PLAN.md`

---

### 4. strict schema 핵심 필드 적용

**문제**: 스키마에 `strict: False` 설정으로 LLM 출력 일관성 저하 가능
**리스크**: Provider/문서 유형별 결과 흔들림

**현재 상태**:
```python
# resume_schema.py (line 19, 42, 78, 131)
"strict": False,  # 추가 필드 허용

# llm_manager.py - OpenAI 호출 (line 188-190)
response_format={
    "type": "json_schema",
    "json_schema": json_schema  # strict 미적용
}

# Gemini: response_mime_type="application/json" (스키마 검증 없음)
# Claude: 스키마 파라미터 없음, regex fallback으로 JSON 추출
```

**작업 내용**:
- [ ] OpenAI 호출 시 핵심 필드에 strict 모드 활성화
- [ ] 단계적 적용 (name, phone, email, careers 우선)
- [ ] strict 적용 후 파싱 실패율 모니터링
- [ ] Gemini API 스키마 파라미터 지원 시 적용

**파일**:
- `apps/worker/schemas/resume_schema.py`
- `apps/worker/services/llm_manager.py`

**변경 예시**:
```python
response_format={
    "type": "json_schema",
    "json_schema": {
        "name": "resume",
        "strict": True,  # 활성화
        "schema": json_schema
    }
}
```

---

## P1 - 출시 직후 집중 (Week 2-4)

### 5. 프롬프트 강건성 강화 - CoT 추가

**문제**: 시스템 프롬프트에 단계별 추론 유도 없음, 할루시네이션 리스크 증가
**코드리뷰 평가**: CoT ❌ None, Few-Shot ❌ None, Negative Examples ❌ None

**현재 상태**:
```python
# analyst_agent.py (lines 437-443)
system_prompt = f"""You are an expert Resume Parser. Extract ALL information from the resume.

{RESUME_SCHEMA_PROMPT}

Return a single JSON object with all extracted fields. If a field is not found, omit it.
IMPORTANT: Generate a high-quality 'match_reason' (Aha Moment)...
"""
```

**강점 (유지)**:
- ✅ RESUME_SCHEMA_PROMPT 350+ 라인의 한국 이력서 특성 반영
- ✅ 프로젝트 추출 규칙 상세 (lines 290-315)
- ✅ Temperature=0.1 (낮은 창의성)

**작업 내용**:
- [ ] CoT (Chain-of-Thought) 단계별 추론 프롬프트 추가
- [ ] 명시적 할루시네이션 방지 지침 추가
- [ ] 파일명 크로스체크 지침 강화
- [ ] User Prompt 개선 ("Return valid JSON only" → 더 명확하게)

**개선안**:
```python
system_prompt = f"""You are an expert Resume Parser.

EXTRACTION STEPS:
1. Identify document sections (header, career, skills, education)
2. Extract from each section following the schema
3. Cross-check name with filename: {{filename}}
4. Validate all dates are YYYY-MM format
5. Output ONLY fields present in the resume with >80% confidence

{RESUME_SCHEMA_PROMPT}

CRITICAL RULES:
- If a field is not found, DO NOT GUESS OR HALLUCINATE
- Only include fields explicitly present in the resume
- Return valid JSON only (no markdown, no code blocks)
"""

user_prompt = f"""Please parse this Korean resume step by step:

1. Extract basic info (name, contact) from document header
2. For name: Cross-check with filename: {filename}
3. Extract careers chronologically with all required fields
4. For projects: Look in "projects", "career details", "achievements" sections
5. Generate quality summary and match_reason

Return ONLY valid JSON (no markdown, no code blocks).

---
{text}
---
"""
```

**파일**: `apps/worker/agents/analyst_agent.py`

---

### 6. Few-shot 예시 라이브러리 구축

**문제**: 정확한 추출 예시 없이 LLM이 패턴 학습 기회 부재
**코드리뷰 지적**: 문서에서 25개 예시(5 extractors × 5 examples) 계획되었으나 미구현

**작업 내용**:
- [ ] `apps/worker/prompts/few_shot_examples.py` 생성
- [ ] 5개 추출 영역 × 5개 예시 = 25개 예시 작성
  - Profile (이름, 연락처)
  - Career (경력 사항)
  - Skills (기술 스택)
  - Education (학력)
  - Projects (프로젝트)
- [ ] 올바른 추출 예시 + 잘못된 추출 예시 포함
- [ ] `analyst_agent.py`에 통합
- [ ] 한/영 이력서 모두 커버

**파일**:
- `apps/worker/prompts/few_shot_examples.py` (신규)
- `apps/worker/agents/analyst_agent.py`

---

### 7. MessageBus 실효성 확보

**문제**: MessageBus 구현은 있으나 실제 파이프라인에서 활용되지 않음
**코드리뷰 지적**: 구조는 있으나 결과 품질 개선으로 연결되는 증거 부족

**현재 상태**:
```python
# context/message_bus.py - 구현됨
class MessageBus:
    messages: List[AgentMessage] = []
    handlers: Dict[str, Callable] = {}

# Feature Flag
use_agent_messaging: bool = False  # 기본값 비활성화

# 실제 사용: 거의 없음 - 모든 통신이 PipelineContext 공유로 처리
```

**작업 내용**:
- [ ] 최소 1개 핵심 유스케이스에 MessageBus 연결
- [ ] 권장: ValidationAgent → AnalystAgent 피드백 루프
  - 할루시네이션 감지 시 재분석 요청
- [ ] 메시지 기반 의사결정이 품질 개선으로 연결되는지 검증
- [ ] 스테이지 간 상태 전이를 메시징으로 바꾸는 검증

**파일**:
- `apps/worker/context/message_bus.py`
- `apps/worker/orchestrator/pipeline_orchestrator.py`
- `apps/worker/orchestrator/feature_flags.py`

---

### 8. 자동 복구 루프 명문화

**문제**: 재질의 조건/횟수/중단 기준 불명확
**코드리뷰 지적**: "프롬프트-검증-재질의" 폐루프(automatic recovery)의 자동화 수준이 문서 기대치 대비 낮음

**현재 상태**:
- Confidence-based cross-check 존재 (confidence < 0.85 → Gemini 추가)
- 그러나 검증 후 재분석 요청 자동화 미흡

**작업 내용**:
- [ ] 프롬프트-검증-재질의 폐루프 조건 정의
  - 재질의 트리거: confidence < 0.7 또는 critical field 누락
  - 최대 재시도: 2회
  - 중단 조건: 3회 연속 동일 결과
- [ ] `orchestrator/analyst_wrapper.py`에 자동 복구 로직 구현
- [ ] 복구 시도 횟수 메트릭 추가
- [ ] 테스트 추가

**파일**: `apps/worker/orchestrator/analyst_wrapper.py`

---

### 9. Gemini/Claude 통합 개선

**문제**: Gemini는 스키마 검증 없음, Claude는 regex fallback 의존

**현재 상태**:
```python
# Gemini (lines 359-374)
config = genai_types.GenerateContentConfig(
    response_mime_type="application/json",  # 소프트 힌트, 검증 없음
)
# 스키마 파라미터 미전달

# Claude (lines 473-479)
response = await self.anthropic_client.messages.create(...)
# 스키마 파라미터 없음, _extract_json() regex fallback

# _extract_json (lines 731-759)
# Regex \{[\s\S]*\}는 greedy, 잘못된 JSON 캡처 가능
```

**작업 내용**:
- [ ] Gemini API 스키마 지원 시 적용
- [ ] Claude structured output 지원 시 마이그레이션
- [ ] `_extract_json()` regex 개선 (greedy 문제 해결)
- [ ] 추출된 JSON의 스키마 검증 추가

**파일**: `apps/worker/services/llm_manager.py`

---

## P2 - 중기 개선 (Month 2)

### 10. 문서 분류 게이트 도입 (ClassifierAgent)

**문제**: 비이력서 문서가 분석 파이프라인까지 도달하여 비용 낭비 및 품질 저하
**코드리뷰 지적**: RouterAgent는 파일 형식만 검증, 내용 기반 분류 없음. AnalystAgent는 "resume"로 암묵적 가정

**현재 상태**:
- RouterAgent: Magic Number, DRM, 페이지 수만 검증
- PipelineRequest/PipelineMetadata에 `document_type` 필드 없음
- 프롬프트가 이력서임을 가정 ("expert Resume Parser")

**작업 내용**:
- [ ] `apps/worker/agents/classifier_agent.py` 생성 (GPT-4o-mini 기반)
- [ ] PipelineContext/PipelineMetadata에 `document_kind` 필드 추가
  - `resume` | `non_resume` | `uncertain`
- [ ] PipelineOrchestrator 분기 로직
  - `non_resume`: 즉시 실패 + 크레딧 환불
  - `uncertain`: 낮은 confidence로 진행 + warning
- [ ] Feature Flag: `USE_DOCUMENT_CLASSIFIER`
- [ ] 프롬프트 조건부 강화 (document_kind != resume면 거부)

**구현 옵션**:
| 방식 | 비용 | 정확도 | 지연 |
|------|------|--------|------|
| GPT-4o-mini (권장) | ~$0.002/건 | 95%+ | +1-2초 |
| Rule-based (키워드) | $0 | 80-85% | +0.1초 |
| Embedding + Classifier | ~$0.0003/건 | 90%+ | +0.5초 |

**파일**:
- `apps/worker/agents/classifier_agent.py` (신규)
- `apps/worker/context/layers.py`
- `apps/worker/orchestrator/pipeline_orchestrator.py`
- `apps/worker/orchestrator/feature_flags.py`

**예상 효과**: 비이력서 분석 비용 100% 절감, 명확한 사용자 피드백

---

### 11. 체크포인트 복구 체계 활성화

**문제**: `create_checkpoint()`/`restore_from_checkpoint()` 메서드 존재하나 실제 활용 미흡
**코드리뷰 지적**: 장애 시 자동 복구 전략의 실전성 부족

**현재 상태**:
- 메서드 구현됨 (pipeline_context.py)
- 실제 운영 경로에서 재시도/복구에 적극 활용되는 패턴 아직 약함

**작업 내용**:
- [ ] 스테이지별 체크포인트 자동 생성
- [ ] 실패 시 마지막 성공 체크포인트에서 재개
- [ ] 재처리 idempotency 보장
- [ ] 실패 시 사용자 가시성 강화 (UI 알림)
- [ ] State persistence for interrupted jobs

**파일**:
- `apps/worker/context/pipeline_context.py`
- `apps/worker/orchestrator/pipeline_orchestrator.py`

---

### 12. Context 압축 서비스 구현

**문제**: 긴 이력서(>8000자)에서 토큰 비용 과다
**코드리뷰 지적**: `services/context_compressor.py` 계획되었으나 미구현

**작업 내용**:
- [ ] `apps/worker/services/context_compressor.py` 생성
- [ ] Priority 기반 압축 (중요 섹션 우선 보존)
- [ ] 압축 전후 품질 비교 테스트

**예상 효과**: 긴 문서 토큰 비용 -30%

**파일**: `apps/worker/services/context_compressor.py` (신규)

---

### 13. Batch Processor 구현

**문제**: 현재 순차 처리만 가능, 대량 업로드 시 처리 지연
**코드리뷰 지적**: `orchestrator/batch_processor.py` 계획되었으나 미구현

**작업 내용**:
- [ ] `apps/worker/orchestrator/batch_processor.py` 생성
- [ ] Semaphore 기반 동시성 제어 (max_concurrent=10)
- [ ] 100개 이력서 병렬 처리 지원

**예상 효과**: 처리량 +300%

**파일**: `apps/worker/orchestrator/batch_processor.py` (신규)

---

### 14. Model Selector 구현

**문제**: 고정 모델 할당으로 비용/품질 최적화 부재
**코드리뷰 지적**: `orchestrator/model_selector.py` 계획되었으나 미구현

**작업 내용**:
- [ ] `apps/worker/orchestrator/model_selector.py` 생성
- [ ] 복잡도 기반 모델 선택
  - 10+ 페이지: Claude Opus
  - 표준: GPT-4o
  - 단순: GPT-4o-mini
- [ ] 비용/품질 트레이드오프 설정 가능

**파일**: `apps/worker/orchestrator/model_selector.py` (신규)

---

### 15. Provider별 품질/비용 대시보드

**코드리뷰 권고**: Provider별 품질/비용/latency 대시보드 구축

**작업 내용**:
- [ ] Provider별 성공률, 평균 confidence, 비용, latency 집계
- [ ] 일별/주별 트렌드 시각화
- [ ] 이상 감지 알림 (성공률 급락 시)
- [ ] A/B 테스트 지원 (CoT vs non-CoT, Few-shot vs no examples)

**파일**:
- `apps/worker/services/metrics_service.py`
- 대시보드 UI (별도)

---

### 16. Result Cache 구현

**문제**: 동일 이력서 재처리 시 불필요한 LLM 호출
**코드리뷰 지적**: `agents/cache/sub_agent_cache.py` 계획되었으나 미구현

**작업 내용**:
- [ ] `apps/worker/agents/cache/sub_agent_cache.py` 생성
- [ ] LRU + Redis 멀티레이어 캐시
- [ ] 파일 해시 기반 캐시 키

**파일**: `apps/worker/agents/cache/sub_agent_cache.py` (신규)

---

### 17. ValidationAgent 검증 범위 확장

**문제**: 현재 ValidationAgent가 LLM 분석 후에만 실행되어 실시간 크로스체크 불가

**현재 상태**:
- Name vs filename 검증
- Phone/Email format 검증
- Experience years vs career list 계산
- Skills extraction if missing

**누락된 검증**:
- Career date format 일관성
- Project array 구조
- Education graduation year 현실성 (< current year)

**작업 내용**:
- [ ] Career date format 일관성 검증 추가
- [ ] Project array 구조 검증 추가
- [ ] Education graduation year 현실성 검증 추가
- [ ] 스키마 구조 기반 confidence scoring 확장

**파일**: `apps/worker/agents/validation_agent.py`

---

### 18. 할루시네이션 테스트 커버리지 확대

**문제**: HallucinationDetector 구현되었으나 직접 테스트 부족

**현재 상태**:
- `test_pipeline_integration.py`에서 간접 커버리지만 존재
- 전용 테스트 파일 없음

**작업 내용**:
- [ ] `test_hallucination_detector.py` 생성
- [ ] Edge case 테스트 (partial match, case sensitivity, synonym)
- [ ] Severity classification 테스트

**파일**: `apps/worker/tests/test_hallucination_detector.py` (신규)

---

## 리스크 매트릭스

| 리스크 | 우선순위 | 영향도 | 대응 |
|--------|---------|--------|------|
| 아키텍처 설명 vs 실제 동작 불일치 | P0 | HIGH | 문서 정합성 회복 |
| 품질 측정 부정확 (추정치 메트릭) | P0 | HIGH | 실측값 수집 |
| LLM 재시도 미구현 | P0 | HIGH | retry 로직 적용 |
| strict schema 미적용 | P0 | HIGH | 단계적 적용 |
| MessageBus 실효성 부족 | P1 | MEDIUM | 1개 유스케이스 연결 |
| 프롬프트 강건성 편차 (CoT/Few-shot 부재) | P1 | MEDIUM | CoT + Few-shot |
| 자동 복구 루프 미성숙 | P1 | MEDIUM | 폐루프 조건 정의 |
| 비이력서 분류 부재 | P2 | MEDIUM | ClassifierAgent |
| 체크포인트/복구 미성숙 | P2 | LOW | 자동 복구 로직 |
| 문서 유지보수 리스크 | P2 | LOW | 자동 동기화 파이프라인 |

---

## Feature Flag 현황

### 현재 활성화 (기본값)
- ✅ `USE_SPLIT_QUEUES=True` (HWP 최적화)
- ✅ `USE_CONDITIONAL_LLM=True` (비용 최적화)
- ✅ `USE_PARALLEL_LLM=True` (속도 최적화)
- ✅ `USE_HALLUCINATION_DETECTION=True`
- ✅ `USE_EVIDENCE_TRACKING=True`
- ✅ `USE_ERROR_RECOVERY=True` (via retry settings)

### 미구현 플래그 (문서에서 계획)
- ❌ `USE_COT_PROMPTING`
- ❌ `USE_FEW_SHOT_EXAMPLES`
- ❌ `USE_STRICT_SCHEMA`
- ❌ `USE_CONTEXT_COMPRESSION`
- ❌ `USE_BATCH_PROCESSING`
- ❌ `USE_RESULT_CACHE`
- ❌ `USE_DYNAMIC_MODEL_SELECTION`
- ❌ `USE_DOCUMENT_CLASSIFIER`

---

## 완료 기준

### Week 1 (Launch Readiness)
- [ ] P0 항목 4개 모두 완료
  - [ ] 1. LLM 재시도 로직 적용
  - [ ] 2. 메트릭 정확도 개선
  - [ ] 3. 문서-코드 정합성 회복
  - [ ] 4. strict schema 핵심 필드 적용
- [ ] 각 항목별 단위 테스트 추가

### Week 2-4 (Stabilization)
- [ ] P1 항목 5개 모두 완료
  - [ ] 5. CoT 프롬프트 강화
  - [ ] 6. Few-shot 예시 라이브러리
  - [ ] 7. MessageBus 실효성 확보
  - [ ] 8. 자동 복구 루프 명문화
  - [ ] 9. Gemini/Claude 통합 개선
- [ ] 통합 테스트 통과
- [ ] 품질 메트릭 baseline 대비 개선 확인

### Month 2 (Scale)
- [ ] P2 항목 9개 완료
  - [ ] 10. 문서 분류 게이트 (ClassifierAgent)
  - [ ] 11. 체크포인트 복구 체계
  - [ ] 12. Context 압축 서비스
  - [ ] 13. Batch Processor
  - [ ] 14. Model Selector
  - [ ] 15. Provider 대시보드
  - [ ] 16. Result Cache
  - [ ] 17. ValidationAgent 확장
  - [ ] 18. 할루시네이션 테스트 확대
- [ ] 대시보드 구축
- [ ] 문서 자동 동기화 파이프라인 도입

---

## 참고 문서

| 문서 | 위치 |
|------|------|
| 멀티에이전트 구현 계획 | `docs/specs/MULTI_AGENT_IMPLEMENTATION_PLAN.md` |
| 멀티에이전트 요약 | `docs/specs/MULTI_AGENT_SUMMARY.md` |
| 코드리뷰 원본 | (2026-02-13 리뷰 기준) |
| Worker 설정 | `apps/worker/config.py` |
| 파이프라인 오케스트레이터 | `apps/worker/orchestrator/pipeline_orchestrator.py` |
| 컨텍스트 관리 | `apps/worker/context/` |
| Feature Flags | `apps/worker/orchestrator/feature_flags.py` |
| LLM Manager | `apps/worker/services/llm_manager.py` |
| Resume Schema | `apps/worker/schemas/resume_schema.py` |
| Analyst Agent | `apps/worker/agents/analyst_agent.py` |

---

## 주요 파일 라인 참조

| 파일 | 라인 | 내용 |
|------|------|------|
| `llm_manager.py` | 188-190 | OpenAI Structured Outputs (strict 미적용) |
| `llm_manager.py` | 359-374 | Gemini JSON mode (스키마 미전달) |
| `llm_manager.py` | 473-479 | Claude 호출 (스키마 없음) |
| `llm_manager.py` | 731-759 | `_extract_json()` regex fallback |
| `analyst_agent.py` | 437-443 | 시스템 프롬프트 (CoT 없음) |
| `analyst_agent.py` | 444-452 | 유저 프롬프트 (minimal context) |
| `analyst_agent.py` | 87-96 | Conditional LLM flags |
| `analyst_agent.py` | 326-377 | `_evaluate_first_response` (3개 필드만 체크) |
| `resume_schema.py` | 19, 42, 78, 131 | `strict: False` 설정 |
| `feature_flags.py` | - | `use_agent_messaging=False` 기본값 |
| `config.py` | 25-48 | `RetrySettings` (미사용) |

---

*작성일: 2026-02-14*
*다음 검토일: 2026-02-21 (Week 1 완료 시점)*
