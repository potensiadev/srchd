# Backlog Sync - 2026-02-14

> 코드리뷰 + 비즈니스 관점 통합 우선순위 백로그
> 검토 기준일: 2026-02-14
> 다음 검토일: 2026-02-21

## Related Documents
- PRD Section 21: `docs/PRD/srchd_prd_v0.1_20260213.md`
- Multi-Agent Pipeline: `docs/architecture/MULTI_AGENT_PIPELINE.md`
- Phase 1 개발 요구사항: `docs/architecture/PHASE1_DEVELOPMENT_REQUIREMENTS.md`

---

## 🚀 Phase 1 에이전트 (별도 진행 중)

> **상태**: 개발 진행 중 (TIER 0-3과 병렬 진행)

| 에이전트 | 역할 | LLM 호출 | 공수 |
|----------|------|----------|------|
| DocumentClassifier | 이력서 vs 비이력서 분류 | 0-1 | 6h |
| CoverageCalculator | 필드 완성도 점수 산출 | 0 | 4h |
| GapFillerAgent | 빈 필드 타겟 재추출 | 0-2 | 8h |
| DB 마이그레이션 | 스키마 확장 | - | 2h |
| 테스트 + 통합 | E2E 검증 | - | 10h |
| **합계** | | | **30h** |

**리스크 관리**:
- LLM 비용 증가 → GapFiller: coverage ≥85% 시 스킵, 최대 2회
- 파이프라인 지연 → DocumentClassifier: Rule-based 우선 (~0.1초)
- 복잡도 증가 → Feature flag로 점진적 활성화

---

## ✅ P0: 치명적 버그 수정 — 완료

> **상태**: ✅ 완료 (2026-02-14)
> 검증일: 2026-02-14 | 수정일: 2026-02-14

### 수정된 버그

| 순위 | ID | 버그 | 심각도 | 상태 | 수정 파일 |
|------|-----|------|--------|------|----------|
| **P0-1** | BUG-001 | **`call_openai` 메서드 미존재** | 🔴 치명 | ✅ 완료 | `document_classifier.py`, `gap_filler_agent.py` |
| **P0-2** | BUG-002 | **`education` vs `educations` 키 불일치** | 🟠 중요 | ✅ 완료 | `analyst_agent.py` |
| **P0-3** | BUG-003 | **Fail-open 과다 설계** | 🟠 중요 | ✅ 완료 | `pipeline_orchestrator.py` |
| **P0-4** | BUG-004 | **모델명 하드코딩 불일치** | 🟡 중간 | ✅ 완료 | `document_classifier.py`, `gap_filler_agent.py`, `llm_manager.py` |

---

### P0-1: `call_openai` 메서드 미존재 (치명)

**현상**: `DocumentClassifier`, `GapFillerAgent`가 존재하지 않는 메서드 호출

```python
# document_classifier.py:255 ❌
response = await self.llm_manager.call_openai(...)

# gap_filler_agent.py:300 ❌
response = await self.llm_manager.call_openai(...)
```

**LLMManager 실제 메서드**:
- `call_with_structured_output()` - Structured JSON
- `call_json()` - JSON 모드
- `call_text()` - 일반 텍스트

**수정 방법**:
```python
# 변경 전
response = await self.llm_manager.call_openai(prompt=..., system_prompt=..., model=...)

# 변경 후
messages = [
    {"role": "system", "content": system_prompt},
    {"role": "user", "content": prompt}
]
response = await self.llm_manager.call_json(
    provider=LLMProvider.OPENAI,
    messages=messages,
    model=model
)
```

**파일**: `apps/worker/agents/document_classifier.py`, `apps/worker/agents/gap_filler_agent.py`

---

### P0-2: `education` vs `educations` 키 불일치

**현상**: `analyst_agent.py:372`에서 `education` 참조하나 실제 스키마는 `educations`

```python
# analyst_agent.py:372 ❌
if data.get("education") and len(data.get("education", [])) > 0:
    confidence += 0.05
```

**영향**: education 데이터가 있어도 confidence bonus가 적용되지 않음

**수정**: `education` → `educations`

**파일**: `apps/worker/agents/analyst_agent.py`

---

### P0-3: Fail-open 과다 설계 (조건부 fail-closed로 변경)

**현상**: 모든 실패를 무시하고 진행 → silent quality failure

| 위치 | 현재 동작 | 리스크 |
|------|----------|--------|
| `pipeline_orchestrator.py:472-476` | 문서 분류 실패 → `uncertain`으로 진행 | 비이력서 통과 |
| `pipeline_orchestrator.py:554-564` | 신원 확인 실패 → 경고만 | 다중 인물 통과 |
| `pipeline_orchestrator.py:873-876` | 커버리지 계산 실패 → 진행 | 품질 저하 인지 불가 |
| `pipeline_orchestrator.py:956-959` | 갭 필링 실패 → 진행 | 빈 필드 방치 |

**수정 방향**:
1. `uncertain` 결과 → `completed_with_warnings` 상태로 분리 저장
2. 최소 품질 스코어 미달 시 재시도 큐 이동
3. 실패 카운트 메트릭 수집

**파일**: `apps/worker/orchestrator/pipeline_orchestrator.py`

---

### P0-4: 모델명 하드코딩 불일치

**현상**: config 설정과 코드 내 하드코딩 값 불일치

```python
# llm_manager.py:121 - 기본값
self.models = {
    LLMProvider.OPENAI: "gpt-4o",
    ...
}

# document_classifier.py:258 - 하드코딩 ❌
model="gpt-4o-mini"
```

**수정**: 모든 모델명을 config에서 가져오도록 통일

```python
# 수정 후
from config import get_settings
settings = get_settings()
model = settings.models.document_classifier  # "gpt-4o-mini"
```

**파일**: `apps/worker/agents/document_classifier.py`, `apps/worker/agents/gap_filler_agent.py`, `apps/worker/config.py`

---

### P0 완료 기준 ✅

```
[x] DocumentClassifier LLM fallback → call_json 변경 완료
[x] GapFillerAgent LLM 재추출 → call_json 변경 완료
[x] confidence 계산에 educations 반영 완료
[x] 모델명이 config에서만 관리됨 확인 완료
[x] 분류 실패 시 quality_flags + 경고 추가 완료
```

---

## 핵심 판단 기준

> **"유저가 돈을 내고, 서비스가 안정적으로 돌아가고, 문제가 생기면 알 수 있는가?"**

### 현재 상태 진단

| 영역 | 상태 | 비고 |
|------|------|------|
| 핵심 기능 (업로드/분석/검색/블라인드) | ✅ Production Ready | 95% 완료 |
| 결제 시스템 | ⚠️ Sandbox 설정 완료, 테스트 대기 | T0-2 대기 |
| 이메일 알림 | ⚠️ 결제 이메일 완료, 분석 이메일 대기 | T1-1, T1-2, T1-3 대기 |
| 에러 모니터링 | ✅ Sentry DSN 설정 완료 | Slack 알림 연동 대기 |
| 온보딩 | ⏸️ Phase 2로 이동 | MVP에서 제외 |
| AI 파이프라인 | ✅ 동작함 | 개선점은 있으나 런칭 가능 |

**결론: 기술적으로는 95% 완료, "비즈니스 운영" 관점에서는 75% 상태** (온보딩 제외, Sentry 완료)

---

## 운영 착수용 마스터 TODO LIST

### 🔴 TIER 0: 결제 활성화 (Day 1-3) — 10h

> **이것 없이는 사업이 아니다**

| 순위 | ID | Task | Why | 공수 | 파일 | 상태 |
|------|-----|------|-----|------|------|------|
| **1** | T0-1 | **Paddle Sandbox 계정 설정** | 결제 못 받으면 무료 서비스 | 2h | `lib/paddle/`, `.env.local` | ✅ 완료 |
| **2** | T0-2 | **Paddle 통합 테스트** | 체크아웃/구독/취소/환불 검증 | 6h | `app/api/webhooks/paddle/` | 🔜 대기 |
| **3** | T0-3 | **Paddle Production 키 발급 + 배포** | Sandbox 테스트 후 즉시 전환 | 2h | `.env.production` | 🔜 대기 |

**T0-1 완료 상세** (2026-02-14):
- Paddle Sandbox 계정 생성 완료
- Client Token, API Key, Webhook Secret 발급
- Product/Price ID 생성 (Starter, Pro)
- ngrok 터널 설정 완료 (`https://cryptogamical-vernell-innocently.ngrok-free.dev`)
- 환경 변수 `.env.local` 설정 완료

**T0-2 테스트 항목** (대기 중):
- [ ] 체크아웃 → Pro 구독 결제 테스트 (테스트 카드)
- [ ] 웹훅 수신 확인 (subscription.created)
- [ ] 크레딧 200 자동 부여 확인
- [ ] 구독 취소 테스트 (subscription.canceled)
- [ ] 환불 처리 테스트

**완료 기준**: 실제 카드로 Pro 결제 → 크레딧 200 확인 → 환불 처리 성공

---

### 🟠 TIER 1: 유저 이탈 방지 (Day 4-7) — 13h

> **유저가 돌아오게 만들어라**

| 순위 | ID | Task | Why | 공수 | 파일 | 상태 |
|------|-----|------|-----|------|------|------|
| ~~**3**~~ | ~~T1-1~~ | ~~**분석 완료 이메일 (E-04)**~~ | ~~창 닫으면 결과 모름 → 재방문 0%~~ | ~~4h~~ | ~~`app/api/webhooks/worker/`~~ | ✅ **완료** |
| ~~**4**~~ | ~~T1-4~~ | ~~**Sentry DSN 설정**~~ | ~~장애 인지 불가 = 서비스 사망~~ | ~~2h~~ | ~~`next.config.ts`, Worker~~ | ✅ 완료 |
| **5** | T1-5 | **Sentry Slack 알림 연동** | 에러 실시간 알림 | 1h | Sentry Dashboard | 🔜 대기 (설정 작업) |
| ~~**6**~~ | ~~T1-2~~ | ~~**분석 실패 이메일 (E-05)**~~ | ~~환불됐는데 모르면 CS 폭발~~ | ~~2h~~ | ~~동일~~ | ✅ **완료** |
| ~~**7**~~ | ~~T1-3~~ | ~~**크레딧 부족 경고 이메일 (E-07, E-08)**~~ | ~~Pro 전환 트리거~~ | ~~3h~~ | ~~`app/api/webhooks/worker/`~~ | ✅ **완료** |

**T1-4 완료 상세** (2026-02-14):
- Sentry 프로젝트 생성 (potensia-inc/srchd)
- Frontend: `NEXT_PUBLIC_SENTRY_DSN` 설정 완료 (.env.local)
- Worker: `SENTRY_DSN` 설정 완료 (Railway)
- 기존 sentry.*.config.ts 파일 활용 (이미 구현됨)

**T1-1, T1-2, T1-3 완료 상세** (2026-02-14):
- `lib/email/templates.ts`: E-04, E-05, E-07, E-08 HTML 템플릿 추가
- `app/api/webhooks/worker/route.ts` 수정:
  - 분석 완료 시 E-04 이메일 큐잉
  - 분석 실패 시 E-05 이메일 큐잉
  - 크레딧 잔액 체크: ≤0 → E-08 (소진), ≤5 → E-07 (부족 경고)
- `getNextResetDate()` 헬퍼 함수 추가

**T1-5 참고**: Sentry Slack 알림은 코드 변경 없이 Sentry 대시보드에서 설정
- Settings > Integrations > Slack 연동
- Alert Rules 생성 → Slack 채널로 전송

**완료 기준**:
- [x] 분석 완료 시 이메일 수신 확인 (E-04)
- [x] 분석 실패 시 이메일 수신 확인 (E-05)
- [x] 크레딧 부족 시 이메일 수신 확인 (E-07, E-08)
- [x] Sentry DSN 설정 완료
- [ ] Sentry에서 테스트 에러 → Slack 알림 수신 (설정 작업)

---

### 🟡 TIER 2: 첫 경험 최적화 (Week 2) — ~~14h~~ 4h

> **첫 경험이 곧 전환율**
> ⚠️ 온보딩 관련 작업 (T2-1, T2-2, T2-3) 제외됨 — Phase 2로 이동

| 순위 | ID | Task | Why | 공수 | 파일 | 상태 |
|------|-----|------|-----|------|------|------|
| ~~**7**~~ | ~~T2-1~~ | ~~**온보딩 Step 1-2 (환영 + 첫 업로드)**~~ | ~~뭘 해야 할지 모르면 이탈~~ | ~~4h~~ | ~~`app/(dashboard)/`~~ | ⏸️ Phase 2 |
| ~~**8**~~ | ~~T2-2~~ | ~~**온보딩 Step 3-5 (검색/검토/내보내기)**~~ | ~~핵심 기능 체험 유도~~ | ~~4h~~ | ~~동일~~ | ⏸️ Phase 2 |
| ~~**9**~~ | ~~T2-4~~ | ~~**크레딧 리셋 Cron 백업**~~ | ~~리셋 안 되면 무료 사용자 CS 폭발~~ | ~~4h~~ | ~~`app/api/cron/`~~ | ✅ **완료** |
| ~~**10**~~ | ~~T2-3~~ | ~~**환영 이메일 (E-01)**~~ | ~~브랜드 첫인상 + 온보딩 링크~~ | ~~2h~~ | ~~`lib/email/`~~ | ⏸️ Phase 2 |

**T2-4 완료 상세** (2026-02-14):
- 재시도 로직 (최대 3회, exponential backoff)
- `recordCronExecution()`: cron_executions 테이블 기록 (선택적)
- E-09 이메일 템플릿 추가 (`lib/email/templates.ts`)
- 파일: `app/api/cron/credit-reset/route.ts`

**완료 기준**: ~~신규 가입 → 온보딩 완료 → 이력서 1개 분석 → 검색 → 내보내기 E2E 통과~~ (Phase 2)

---

### 🟢 TIER 3: 안정성 확보 (Week 3) — 16h

> **CS 줄이고 신뢰 쌓기**

| 순위 | ID | Task | Why | 공수 | 파일 |
|------|-----|------|-----|------|------|
| ~~**11**~~ | ~~T3-1~~ | ~~**LLM 재시도 로직 적용**~~ | ~~Timeout 시 크레딧만 날아감~~ | ~~4h~~ | ✅ **완료** |
| ~~**12**~~ | ~~T3-2~~ | ~~**메트릭 정확도 개선**~~ | ~~비용 추정 틀리면 마진 계산 불가~~ | ~~4h~~ | ✅ **완료** |
| ~~**13**~~ | ~~T3-3~~ | ~~**결제 이메일 (E-10, E-11, E-12)**~~ | ~~결제 실패/시작/취소 알림~~ | ~~4h~~ | ✅ **완료** |
| ~~**14**~~ | ~~T3-4~~ | ~~**E2E CI/CD 연동**~~ | ~~배포할 때마다 수동 테스트 지옥~~ | ~~4h~~ | ✅ **완료** |

**T3-1 완료 상세** (2026-02-14):
- `_call_with_retry()` 래퍼 구현 (exponential backoff: 1s, 2s, 4s...)
- 재시도 대상 에러 패턴: timeout, rate limit, 5xx, connection 등
- 재시도 불가: validation, auth, JSON parse 에러
- config 연동: `retry.llm_max=3`, `retry.llm_base_delay=1.0`, `retry.llm_max_delay=8.0`
- 파일: `config.py`, `llm_manager.py`, `test_llm_manager_phase1.py`

**T3-2 완료 상세** (2026-02-14):
- `LLM_PRICING` 테이블 업데이트 (gemini-3-pro-preview, claude-sonnet-4 등 추가)
- `AnalysisResult.per_provider_usage` 필드 추가 (per-provider 토큰 추적)
- `_collect_token_usage()` 메서드 개선 (per-provider model, input, output 수집)
- `metrics_collector.record_llm_call()` 호출 시 실제 모델명 및 토큰 사용량 전달
- `ctx.record_llm_call()` 호출 수정: `processing_time // 100` → 실제 토큰 사용량
- 파일: `metrics_service.py`, `analyst_agent.py`, `pipeline_orchestrator.py`

**T3-3 완료 상세** (2026-02-14):
- `lib/email/` 모듈 구현 (Resend API 기반 이메일 발송 서비스)
  - `service.ts`: `sendEmail()`, `queueEmail()`, `processPendingEmails()`
  - `templates.ts`: E-10/E-11/E-12 HTML 템플릿, `generateEmailSubject()`
- Paddle webhook 수정 (`app/api/webhooks/paddle/route.ts`):
  - `subscription.created/activated` → E-11 (구독 시작)
  - `subscription.past_due` → E-10 (결제 실패)
  - `subscription.canceled` → E-12 (구독 취소)
  - `transaction.completed` → E-11 (구독 갱신, 중복 방지 로직 포함)
- Cron Job 추가 (`app/api/cron/send-emails/route.ts`): 5분마다 pending 이메일 발송
- `vercel.json` cron 등록
- 환경 변수: `RESEND_API_KEY`, `EMAIL_FROM`, `CRON_SECRET`

**T3-4 완료 상세** (2026-02-14):
- `.github/workflows/ci.yml` 업데이트:
  - Lint & Type Check (ESLint + tsc)
  - Unit Tests (Frontend - Vitest)
  - Unit Tests (Worker - pytest)
  - Build Check
  - E2E Tests (Playwright - chromium, main 브랜치 또는 `run-e2e` 라벨)
- `.github/workflows/e2e-full.yml` 신규:
  - 매일 21:00 UTC (06:00 KST) 스케줄 실행
  - 전체 브라우저 매트릭스 (chromium, firefox, webkit)
  - 수동 실행 지원 (모바일 테스트 옵션)
  - Slack 알림 연동 (실패 시)

**필요한 Secrets**:
- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `TEST_USER_EMAIL`, `TEST_USER_PASSWORD`
- `SLACK_WEBHOOK_URL` (선택)

**완료 기준**:
- [x] LLM Timeout 발생 시 자동 재시도 3회 확인 (T3-1 완료)
- [x] per-provider 토큰 사용량 정확히 수집 (T3-2 완료)
- [x] 결제 이메일 (E-10, E-11, E-12) 구현 (T3-3 완료)
- [x] PR 머지 시 E2E 자동 실행 (T3-4 완료)

---

### ⚪ TIER 4: 데이터 기반 개선 (Beta 피드백 후) — 18h

> **유저 불만이 쌓이면 그때 한다**

| 순위 | ID | Task | 트리거 조건 | 공수 |
|------|-----|------|------------|------|
| ~~15~~ | ~~T4-1~~ | ~~strict schema 적용~~ | ~~분석 결과 불일치 불만 5건+~~ | ✅ **완료** |
| ~~16~~ | ~~T4-2~~ | ~~CoT/Few-shot 프롬프트~~ | ~~정확도 불만 10건+~~ | ✅ **완료** |
| — | ~~T4-3~~ | ~~CoverageCalculator + GapFiller~~ | ~~필드 누락 불만 10건+~~ | 🚧 개발 중 |
| — | ~~T4-4~~ | ~~ResumeIntentGuard (문서 분류)~~ | ~~비이력서 업로드 비율 >5%~~ | 🚧 개발 중 |
| ~~17~~ | ~~T4-5~~ | ~~3-Way Cross-Check~~ | ~~Pro 유저 10명+ 확보 후~~ | ✅ **완료** |
| — | T4-6 | JD Auto-Match | Phase 2 | Q2 |
| — | T4-7 | 후보자 제출 패키지 | Phase 2 | Q2 |

**T4-1, T4-2, T4-5 완료 상세** (2026-02-14):

**T4-1: Strict Schema**
- `resume_schema.py`: `get_strict_schema()` 함수 추가
- `_make_properties_nullable()`: null 허용 타입 변환
- Feature flag: `USE_STRICT_SCHEMA=true`

**T4-2: CoT/Few-shot 프롬프트**
- `COT_EXTRACTION_PROMPT`: 6단계 Chain-of-Thought 추론 가이드
- `FEW_SHOT_EXAMPLE_INPUT/OUTPUT`: 한국 이력서 예시
- `get_enhanced_prompt(use_cot, use_few_shot)`: 프롬프트 조합
- Feature flags: `USE_COT_PROMPTING=true`, `USE_FEW_SHOT_EXAMPLES=true`

**T4-5: 3-Way Cross-Check**
- `analyst_agent.py`: Claude 호출 로직 추가
- Phase 2 또는 `USE_THREE_WAY_CROSSCHECK=true` 시 활성화
- `THREE_WAY_CONFIDENCE_THRESHOLD`: 기본 0.7

---

## 🚫 하지 말 것 (Over-engineering 경고)

| 하지 마세요 | 이유 |
|------------|------|
| 멀티에이전트 병렬화 | 8-15초면 충분. 유저 불만 없으면 건들지 마 |
| MessageBus 활용 확대 | 내부 아키텍처, 유저 가치 없음 |
| Evidence Agent 분리 | ValidationAgent에서 처리 가능 |
| Conflict Resolver Agent | 2-Way Cross-Check merge로 충분 |
| 프롬프트 버전 관리 시스템 | 10명 유저에 시스템 불필요. 엑셀로 충분 |
| Provider 품질 대시보드 | 월 $1000 벌기 전에는 불필요 |
| Batch Processor | 100개 동시 업로드 고객 없음 |
| Context 압축 서비스 | 비용 최적화는 나중에 |
| Result Cache | 동일 이력서 재처리 빈도 낮음 |

---

## 총 공수 및 일정

| Tier | 공수 | 목표 | 완료 시 상태 |
|------|------|------|-------------|
| ~~**P0 (즉시)**~~ | ~~8h~~ | ~~Day 0~~ | ✅ **완료** |
| TIER 0 | ~~10h~~ 2h | Day 1-3 | ⚠️ T0-1 완료, T0-2/T0-3 대기 |
| TIER 1 | ~~13h~~ 1h | Day 4-7 | ⚠️ T1-1/2/3/4 완료, T1-5(설정) 대기 |
| ~~TIER 2~~ | ~~14h~~ 4h | ~~Week 2~~ | ⏸️ **온보딩 제외** (T2-4만 완료) |
| ~~TIER 3~~ | ~~16h~~ | ~~Week 3~~ | ✅ **완료** |
| TIER 4 (피드백 후) | ~~18h~~ 8h | Week 4+ | ⚠️ T4-1/2/5 완료, 나머지 대기 |
| **Phase 1 에이전트** | **30h** | **Week 1-2** | **🚧 개발 중** |
| **합계** | **~54h** | **약 7일** | **MVP Launch Ready** |

### 실행 순서 (권장)

```
Day 0:    ✅ P0 치명적 버그 수정 완료
          ├─ BUG-001: call_openai → call_json 변경 ✅
          ├─ BUG-002: education → educations 수정 ✅
          ├─ BUG-003: quality_flags 추적 추가 ✅
          └─ BUG-004: 모델명 config 통일 ✅

Day 1:    ✅ TIER 0-1 (Paddle Sandbox) 완료
          ✅ TIER 1-4 (Sentry DSN) 완료
          ✅ TIER 3 전체 완료
          ✅ TIER 4-1/2/5 완료
          ✅ TIER 1-1/1-2/1-3 (분석 이메일) 완료

Day 2+:   🔜 TIER 0-2/0-3 (Paddle 테스트 + Production)
          🔜 TIER 1-5 (Sentry Slack) - 대시보드 설정
    ↕ 병렬
Day 2+:   🚧 Phase 1 에이전트 개발

Phase 2:  ⏸️ 온보딩 (T2-1, T2-2, T2-3)
          ⏸️ JD Auto-Match (T4-6)
          ⏸️ 후보자 제출 패키지 (T4-7)
```

> ✅ **TIER 3 완료** + **TIER 4 부분 완료** - MVP 런칭 준비 상태

---

## ✅ Launch Readiness Checklist

```
✅ P0 (완료):
[x] DocumentClassifier LLM fallback → call_json 변경 완료
[x] GapFillerAgent LLM 재추출 → call_json 변경 완료
[x] confidence 계산에 educations 반영 완료
[x] 모델명이 config에서만 관리됨 확인 완료
[x] 분류 실패 시 quality_flags + 경고 추가 완료

✅ TIER 3 (완료):
[x] LLM 재시도 로직 (T3-1)
[x] 메트릭 정확도 개선 (T3-2)
[x] 결제 이메일 E-10/E-11/E-12 (T3-3)
[x] E2E CI/CD 연동 (T3-4)

✅ TIER 4 부분 완료:
[x] Strict Schema (T4-1)
[x] CoT/Few-shot 프롬프트 (T4-2)
[x] 3-Way Cross-Check (T4-5)

🔜 MVP 런칭 전 필수:
[ ] Paddle 결제 테스트 (T0-2: 실제 카드 → Pro 결제 → 환불)
[ ] Paddle Production 배포 (T0-3)
[x] 분석 완료 이메일 (T1-1)
[x] 분석 실패 이메일 (T1-2)
[x] 크레딧 부족 경고 이메일 (T1-3)
[x] Sentry DSN 설정 완료 (T1-4)
[ ] Sentry Slack 알림 (T1-5) - Sentry 대시보드 설정
[x] 크레딧 월 리셋 Cron (T2-4)

⏸️ Phase 2 (MVP 이후):
[ ] 온보딩 Step 1-5 (T2-1, T2-2)
[ ] 환영 이메일 (T2-3)
[ ] JD Auto-Match (T4-6)
[ ] 후보자 제출 패키지 (T4-7)
```

---

## 운영 KPI (Beta 시작 후 추적)

| KPI | 목표 | 측정 방법 |
|-----|------|----------|
| **Starter → Pro 전환율** | ≥5% | Paddle 이벤트 |
| **온보딩 완료율** | ≥60% | `users.onboarding_completed` |
| **AI 분석 성공률** | ≥95% | `processing_jobs` |
| **P95 분석 시간** | <15초 | Worker 로그 |
| **일간 이탈률** | <10% | 세션 데이터 |
| **NPS** | ≥40 | 설문 |

---

# 기술 상세 백로그 (참조용)

> 아래는 코드리뷰 기반 기술 개선 항목입니다. TIER 4 단계에서 필요 시 참조하세요.

---

## 현황 요약

| 항목 | 상태 |
|------|------|
| V2 기능 (Collaborative Orchestrator) | ~95% 구현 |
| V3 기능 (Advanced Optimizations) | ~40-50% 구현 |
| 멀티에이전트 구조 | 오케스트레이터 중심 단계형 파이프라인 |

### 코드리뷰 총평

> 멀티에이전트 구조는 "기반은 잘 깔렸고, 실제 운영 경로는 부분적으로만 활성화" 상태
> - 서비스 오픈은 가능하나, 운영 리스크 정리 선행 필요
> - 프롬프팅 품질은 문서 기대치 대비 격차 존재 (CoT/Few-shot 미구현)

---

## 아키텍처 분석

### 현재 구조 요약
- 업로드 API: 인증/크레딧/파일검증 → `processing_jobs` 생성 → 스토리지 업로드
- 워커: `PipelineOrchestrator`에서 파싱→PII→신원확인→분석→검증→프라이버시→임베딩→저장 순차 실행
- 큐: fast/slow 분리 지원, 내부 파이프라인은 직렬

### 주요 문제점 (개선 시 참조)

| 문제 | 설명 | 개선 방향 |
|------|------|----------|
| 필드 완결성 미강제 | `required: ["name"]`만 필수, 나머지 누락 허용 | CoverageCalculator + GapFiller |
| 단일 분석 + 후검증 | Field-level 재추출 루프 약함 | 3단계 추출 루프 |
| 필드별 Observability 부족 | evidence span, missing_reason 미표준화 | 필드별 근거 추적 |

---

## 기술 개선 항목 (TIER 4 레퍼런스)

### LLM 재시도 로직 (T3-1 상세)

**현재 상태**:
```python
# llm_manager.py - 재시도 없이 즉시 실패
try:
    response = await asyncio.wait_for(...)
except asyncio.TimeoutError:
    return LLMResponse(..., error="...timeout...")
```

**작업 내용**:
- [ ] exponential backoff 재시도 (1s, 2s, 4s)
- [ ] `settings.retry.llm_max` 값 활용
- [ ] Timeout/Rate Limit 구분 재시도 정책

---

### 메트릭 정확도 (T3-2 상세)

**현재 상태**:
```python
# 토큰 추정치 사용 - 부정확
estimated_tokens = len(text) // 4
```

**작업 내용**:
- [ ] `response.usage.total_tokens` 실측값 수집
- [ ] Provider별 실제 비용 계산
- [ ] 프롬프트/스키마 버전 키 로깅

---

### strict schema 적용 (T4-1 상세)

**현재 상태**:
```python
# resume_schema.py
"strict": False  # 추가 필드 허용
```

**작업 내용**:
- [ ] 단계적 적용 (name, phone, email, careers 우선)
- [ ] 파싱 실패율 5% 초과 시 롤백
- [ ] Gemini/Claude 스키마 검증 추가

---

### CoT/Few-shot 프롬프트 (T4-2 상세)

**현재 상태**:
```python
# analyst_agent.py - 단순 지시형
system_prompt = """You are an expert Resume Parser..."""
```

**개선안**:
```python
system_prompt = """You are an expert Resume Parser.

EXTRACTION STEPS:
1. Identify document sections (header, career, skills, education)
2. Extract from each section following the schema
3. Cross-check name with filename
4. Output ONLY fields with >80% confidence

CRITICAL RULES:
- If a field is not found, DO NOT GUESS OR HALLUCINATE
"""
```

---

### CoverageCalculator + GapFiller (T4-3 상세)

**설계**:
- **Pass 1**: 섹션별 병렬 추출
- **Pass 2**: 필드별 evidence 존재 확인
- **Pass 3**: 빈 필드만 targeted 재추출 (최대 2회)

**빈 필드 처리 규칙**:
- evidence 없음 + 검색 실패 → `null` + `missing_reason=NOT_FOUND_IN_SOURCE`
- evidence 있음 + 파싱 실패 → 재시도 후 `missing_reason=PARSER_ERROR`

**Unified Resume Context Contract** (필수 선행):

모든 agent/orchestrator/sub-agent는 아래 컨텍스트를 공유해야 함:

```json
{
  "resume_intent": true,
  "document_type": "resume",
  "resume_id": "uuid",
  "raw_text": "...",
  "sections": ["profile", "career", "education", "skills", "projects"],
  "evidence_map": {"field": ["char_span", "page"]},
  "missing_policy": "allow_null_only_if_not_found_in_source"
}
```

**Rules**:
1. `document_type != resume`이면 LLM-heavy 단계 전에 중단
2. 모든 agent output에 field-level evidence 포함 필수
3. Orchestrator는 `value + evidence` 또는 명시적 `missing_reason`이 있는 필드만 저장
4. Gap filling은 빈 필드만 재시도, 동일 `resume_id` 컨텍스트 유지

**DB Schema 변경** (구현 시 필요):

```sql
-- candidates 테이블 확장
ALTER TABLE candidates ADD COLUMN field_metadata JSONB DEFAULT '{}';
ALTER TABLE candidates ADD COLUMN document_kind document_kind_enum DEFAULT 'resume';
ALTER TABLE candidates ADD COLUMN doc_confidence DECIMAL(3,2);

-- ENUM 타입
CREATE TYPE document_kind_enum AS ENUM ('resume', 'non_resume', 'uncertain');
CREATE TYPE missing_reason_enum AS ENUM (
  'not_found_in_source', 'parser_error', 'llm_extraction_failed',
  'low_confidence', 'schema_mismatch', 'timeout'
);
```

---

### ResumeIntentGuard (T4-4 상세)

**구현 옵션**:
| 방식 | 비용 | 정확도 | 지연 |
|------|------|--------|------|
| GPT-4o-mini | ~$0.002/건 | 95%+ | +1-2초 |
| Rule-based | $0 | 80-85% | +0.1초 |
| Embedding + Classifier | ~$0.0003/건 | 90%+ | +0.5초 |

---

## Feature Flag 현황

### 현재 활성화
- ✅ `USE_SPLIT_QUEUES=True`
- ✅ `USE_CONDITIONAL_LLM=True`
- ✅ `USE_PARALLEL_LLM=True`
- ✅ `USE_HALLUCINATION_DETECTION=True`
- ✅ `USE_EVIDENCE_TRACKING=True`

### 미구현 (TIER 4 대상)
- ❌ `USE_COT_PROMPTING`
- ❌ `USE_FEW_SHOT_EXAMPLES`
- ❌ `USE_STRICT_SCHEMA`
- ❌ `USE_DOCUMENT_CLASSIFIER`
- ❌ `USE_COVERAGE_CALCULATOR`
- ❌ `USE_GAP_FILLER`

---

## 리스크 매트릭스

| 리스크 | 영향도 | TIER 배치 | 대응 |
|--------|--------|-----------|------|
| ~~call_openai 메서드 미존재~~ | ~~CRITICAL~~ | ~~P0~~ | ✅ 해결됨 |
| ~~confidence 계산 오류~~ | ~~HIGH~~ | ~~P0~~ | ✅ 해결됨 |
| ~~Fail-open 과다~~ | ~~HIGH~~ | ~~P0~~ | ✅ 해결됨 |
| 결제 불가 | CRITICAL | TIER 0 | Paddle 설정 |
| 유저 이탈 (알림 부재) | HIGH | TIER 1 | 이메일 시스템 |
| 장애 인지 불가 | HIGH | TIER 1 | Sentry 연동 |
| LLM 실패 시 크레딧 손실 | MEDIUM | TIER 3 | 재시도 로직 |
| 분석 정확도 | LOW | TIER 4 | 피드백 기반 |

---

## 주요 파일 참조

| 파일 | 내용 |
|------|------|
| `apps/worker/services/llm_manager.py` | LLM 호출, 재시도 로직 |
| `apps/worker/agents/analyst_agent.py` | 분석 프롬프트 |
| `apps/worker/schemas/resume_schema.py` | strict schema |
| `apps/worker/orchestrator/pipeline_orchestrator.py` | 파이프라인 흐름 |
| `apps/worker/orchestrator/feature_flags.py` | 기능 플래그 |
| `lib/paddle/` | 결제 연동 |
| `app/api/webhooks/` | Worker/Paddle 콜백 |

---

## 권장 서브에이전트 구성 (Phase 2+ 참조)

> 현재 구조로 충분히 운영 가능. 아래는 스케일업 시 참조.

### 도메인 서브에이전트 (병렬 실행 대상)
1. Profile Agent: 이름/연락처/지역/링크
2. Career Agent: 경력 타임라인/직무/성과
3. Education Agent: 학교/전공/학위
4. Skill Agent: 기술/도구/숙련도
5. Project Agent: 프로젝트/역할/성과

### 후속 정제 에이전트
6. Evidence Agent: 원문 근거 span 수집
7. Normalizer Agent: 날짜/회사명 표준화
8. Conflict Resolver: 에이전트 간 충돌 해결
9. Gap Filler Agent: 빈 필드 재질의

---

*작성일: 2026-02-14*
*최종 수정: 2026-02-14 (TIER 1 이메일 완료, T1-1/T1-2/T1-3)*
*다음 검토일: 2026-02-21*
