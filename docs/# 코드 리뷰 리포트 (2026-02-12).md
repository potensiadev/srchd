# 최종 코드 리뷰 리포트 (2026-02-12)

## 0) 리뷰 방법 (이번 업데이트)
- **직접 코드/설정/테스트 재검증** 기준으로 작성
- 기존 문서(`docs/CODE_REVIEW_2026-02-12.md`)의 주장과, 이번에 제공된 아키텍처 제안(Worker/Celery, API Gateway, EDA 등)을 **사실 검증 + 실행 우선순위** 관점에서 재평가
- 실행한 체크:
  - `npm run lint` (실패)
  - `npm run test:run` (성공)
  - `npm run test:coverage` (coverage provider 미설치로 실패)

---

## 1) 요청하신 “현재 시스템 상태 요약” 검증

| 영역 | 제시 내용 | 코드 기반 검증 결과 | 최종 평가 |
|---|---|---|---|
| Frontend | Next.js 16 + React 19, TanStack Query | `next@16.1.1`, `react@19.2.3`, `@tanstack/react-query` 의존성과 실제 `QueryProvider` 사용 확인 | ✅ 정확 |
| Backend API | Next.js API Routes (47개) | 실제 파일 수는 **46개** (`find app/api -type f`) | ⚠️ 수치 수정 필요 |
| Worker | Python FastAPI + RQ | `FastAPI` 엔트리포인트 + `RQ Worker` 러너 확인 | ✅ 정확 |
| Database | PostgreSQL + pgvector | migration에 `vector(1536)`, `ivfflat/hnsw`, 유사도 연산 사용 확인 | ✅ 정확 |
| AI Pipeline | Multi-LLM (GPT/Gemini/Claude) | LLM manager에서 3-provider(OpenAI/Gemini/Claude) 사용 확인 | ✅ 정확 |
| 캐싱 | 3-tier (React Query, Redis, DB) | React Query + Upstash Redis 검색 캐시 + DB 조회 구조 확인 | ✅ 대체로 정확 |

### 코멘트
- “Frontend 최신 스택” 평가는 타당합니다.
- Backend API는 “47개”가 아니라 **46개**로 보정해야 정확합니다.
- Worker는 “확장성 제한”이 완전 오답은 아니지만, 이미 fast/slow queue 분리·백프레셔·DLQ 구조가 일부 들어가 있어 “무대응” 상태로 보긴 어렵습니다.

---

## 2) 핵심 개선 영역(요청안) 재평가

## 2.1 Worker: RQ → Celery + Kubernetes
### 사실 검증
- 현재는 RQ 기반이 맞고, 단일 명령으로 worker 실행(`python run_worker.py`)합니다.
- 다만 코드상으로는 queue 분리(`fast`, `slow`, `parse`, `process`)와 백프레셔 체크가 구현되어 있어 “완전 단일 큐”는 아닙니다.

### 판단
- **중장기적으로는 타당한 방향** (대규모 트래픽, SLA 강화 시).
- 하지만 **즉시 P0는 아님**. 현재 서비스 단계에서는 아래 선행이 ROI가 더 큼:
  1) lint gate 복구
  2) 보안 리다이렉트/CSRF 보강
  3) 페이지 단위 복잡도 축소

## 2.2 API Gateway 패턴
### 사실 검증
- API는 도메인별로 나뉘어 있으나 버저닝(`/v1`)은 없음.
- 레이트리밋 공통 유틸은 존재하나, “전 엔드포인트 강제 적용” 아키텍처는 아님.

### 판단
- “Kong/AWS Gateway 즉시 도입”보다 먼저 **애플리케이션 레벨 공통 래퍼**(auth/rate-limit/audit)로 표준화하는 것이 현실적.

## 2.3 EDA(Event-Driven) 전환
### 사실 검증
- 이미 웹훅 기반 비동기 처리 + Supabase Realtime broadcast 흐름이 존재.
- 즉, 완전 동기 시스템은 아님.

### 판단
- Kafka/CQRS/Event Sourcing은 **규모 확장 시점의 전략 카드**.
- 현 시점엔 “이벤트 스키마 표준화 + outbox 패턴”부터 단계적으로 가는 게 안전.

## 2.4 Search 엔진 분리(Elasticsearch)
### 사실 검증
- 현재 pgvector 기반 하이브리드 검색 및 인덱싱 존재.
- 100K+에서의 한계는 가능성이 있지만, 현재 코드만으로 병목 임계는 단정 불가.

### 판단
- 즉시 분리보다, 먼저 **실측 지표(p95 latency, query class별 slow log)** 확보 후 결정 권장.

## 2.5 AI Pipeline LLM Router 최적화
### 사실 검증
- 이미 조건부/병렬 호출 feature flag(`USE_CONDITIONAL_LLM`, `USE_PARALLEL_LLM`)와 confidence threshold가 있습니다.

### 판단
- “완전 신규”라기보다 **기존 라우팅을 고도화**하는 과제입니다.
- 비용절감 목표는 현실적이나, 먼저 “케이스별 품질-비용 baseline 측정”이 필요.

---

## 3) 기존 내가 작성한 리뷰와의 비교(정확도 점검)

## 3.1 유지(유효) 판단
1. **Public Launch 비권장** 판단 유지
   - lint 에러 다수로 품질 게이트 미충족
2. **CSRF fallback 완화 정책** 리스크 지적 유지
3. **`next` redirect 검증 부족(open redirect 가능성)** 지적 유지
4. **Skeleton render purity 위반(`Math.random`)** 지적 유지
5. **Candidates 페이지 책임 과다**(단일 대형 파일) 지적 유지

## 3.2 이번에 보정한 부분
1. Backend API route 수: 47 → **46**
2. Worker 평가 톤: “확장성 한계 존재”는 맞지만, 이미 queue 분리/백프레셔 등 보완이 일부 구현됨
3. 기술 부채 항목 중 “TypeScript strict 모드 부재”는 사실과 다름 (`strict: true`)
4. “API 문서화 없음” 역시 사실과 다름 (`openapi.yaml` 존재)

---

## 4) 지금 당장 실행해야 할 우선순위 (현실적 로드맵)

## P0 (출시 전 반드시)
1. **Lint 에러 0화 + warning 예산 도입**
   - 최소: `errors=0`
   - 권장: 경고 상한을 단계적으로 축소
2. **Redirect Sanitization**
   - `next`는 내부 경로만 허용 (`/` 시작 + `//`, `http(s):` 차단)
3. **CSRF 정책 강화**
   - 브라우저 세션 API는 `origin/referer` 누락 시 거부
   - 서버간 호출은 webhook/HMAC 헤더로 분리
4. **Coverage 도구 복구**
   - `@vitest/coverage-v8` 설치 및 CI 포함

## P1 (2~4주)
1. Candidates 페이지를 hook 단위로 분리
2. Skeleton 랜덤 렌더 제거
3. API 공통 래퍼(인증/레이트리밋/에러 응답/감사로그) 적용 범위 확대

## P2 (확장 국면)
1. Worker 플랫폼 고도화(Celery/K8s 포함 타당성 검토)
2. 검색 엔진 이원화(OpenSearch/Elasticsearch) PoC
3. Outbox 기반 이벤트 표준화 후 EDA 확장

---

## 5) 최종 오픈 판단
- **Closed Beta**: 가능 (P0 중 1~2개라도 빠르게 해소 전제)
- **Public Launch**: **현재 상태 기준 비권장**
  - 이유: 린트 품질 게이트 붕괴 + 보안/리다이렉트 하드닝 미완료

---

## 6) 실행 로그
- `npm run lint` → 실패 (`1740 problems: 76 errors, 1664 warnings`)
- `npm run test:run` → 성공 (`9 files, 361 tests passed`)
- `npm run test:coverage` → 실패 (`@vitest/coverage-v8` 누락)